import { getTemplate } from '/_snowpack/pkg/codesandbox-import-utils.lib.create-sandbox.templates.v1.3.8.js';
import L from '/_snowpack/pkg/lodash.isequal.v4.5.0.js';

var g=class{constructor(e,n,t){this.type=e;this.handleMessage=n;this.protocol=t;this._disposeMessageListener=this.protocol.channelListen(async a=>{if(a.type===this.getTypeId()&&a.method){let s=a;try{let o=await this.handleMessage(s),i={type:this.getTypeId(),msgId:s.msgId,result:o};this.protocol.dispatch(i);}catch(o){let i={type:this.getTypeId(),msgId:s.msgId,error:{message:o.message}};this.protocol.dispatch(i);}}});}getTypeId(){return `protocol-${this.type}`}dispose(){this._disposeMessageListener();}};var m=class{constructor(e,n){this.globalListeners={};this.globalListenersCount=0;this.channelListeners={};this.channelListenersCount=0;this.channelId=Math.floor(Math.random()*1e6);this.frameWindow=e.contentWindow,this.origin=n,this.globalListeners=[],this.channelListeners=[],this.eventListener=this.eventListener.bind(this),typeof window!="undefined"&&window.addEventListener("message",this.eventListener);}cleanup(){window.removeEventListener("message",this.eventListener),this.globalListeners={},this.channelListeners={},this.globalListenersCount=0,this.channelListenersCount=0;}register(){!this.frameWindow||this.frameWindow.postMessage({type:"register-frame",origin:document.location.origin,id:this.channelId},this.origin);}dispatch(e){!this.frameWindow||this.frameWindow.postMessage({$id:this.channelId,codesandbox:!0,...e},this.origin);}globalListen(e){if(typeof e!="function")return ()=>{};let n=this.globalListenersCount;return this.globalListeners[n]=e,this.globalListenersCount++,()=>{delete this.globalListeners[n];}}channelListen(e){if(typeof e!="function")return ()=>{};let n=this.channelListenersCount;return this.channelListeners[n]=e,this.channelListenersCount++,()=>{delete this.channelListeners[n];}}eventListener(e){if(e.source!==this.frameWindow)return;let n=e.data;!n.codesandbox||(Object.values(this.globalListeners).forEach(t=>t(n)),n.$id===this.channelId&&Object.values(this.channelListeners).forEach(t=>t(n)));}};var f='[sandpack-client]: "dependencies" was not specified - provide either a package.json or a "dependencies" value',x='[sandpack-client]: "entry" was not specified - provide either a package.json with the "main" field or na "entry" value';function b(r={},e={},n="/index.js"){return JSON.stringify({name:"sandpack-project",main:n,dependencies:r,devDependencies:e},null,2)}function y(r,e,n,t){var i,c;let a={...r},o=(()=>{if(a["/package.json"])return "/package.json";if(a["package.json"])return "package.json"})();if(!o){if(!e)throw new Error(f);if(!t)throw new Error(x);return a["/package.json"]={code:b(e,n,t)},a}if(o){let l=JSON.parse(a[o].code);if(!e&&!l.dependencies)throw new Error(f);e&&(l.dependencies={...(i=l.dependencies)!=null?i:{},...e!=null?e:{}}),n&&(l.devDependencies={...(c=l.devDependencies)!=null?c:{},...n!=null?n:{}}),t&&!l.main&&(l.main=t),a[o]={code:JSON.stringify(l,null,2)};}return a}function S(r){if(r.title==="SyntaxError"){let{title:s,path:o,message:i,line:c,column:l}=r;return {title:s,path:o,message:i,line:c,column:l}}let e=v(r.payload.frames);if(!e)return {message:r.message};let n=w(e),t=k(e);return {message:E(e._originalFileName,r.message,t,n),title:r.title,path:e._originalFileName,line:e._originalLineNumber,column:e._originalColumnNumber}}function v(r){if(!!r)return r.find(e=>!!e._originalFileName)}function k(r){return r?` (${r._originalLineNumber}:${r._originalColumnNumber})`:""}function w(r){let n=r._originalScriptCode[r._originalScriptCode.length-1].lineNumber.toString().length,t=2,a=3,s=t+n+a+r._originalColumnNumber;return r._originalScriptCode.reduce((o,i)=>{let c=i.highlight?">":" ",l=i.lineNumber.toString().length===n?`${i.lineNumber}`:` ${i.lineNumber}`,u=i.highlight?`
`+" ".repeat(s)+"^":"";return o+`
`+c+" "+l+" | "+i.content+u},"")}function E(r,e,n,t){return `${r}: ${e}${n}
${t}`}var F=`https://${"1.2.2".replace(/\./g,"-")}-sandpack.codesandbox.io/`,R=class{constructor(e,n,t={}){this.getTranspilerContext=()=>new Promise(e=>{let n=this.listen(t=>{t.type==="transpiler-context"&&(e(t.data),n());});this.dispatch({type:"get-transpiler-context"});});var s;if(this.options=t,this.sandboxInfo=n,this.bundlerURL=t.bundlerURL||F,this.bundlerState=void 0,this.errors=[],this.status="initializing",typeof e=="string"){this.selector=e;let o=document.querySelector(e);if(!o)throw new Error(`[sandpack-client]: the element '${e}' was not found`);this.element=o,this.iframe=document.createElement("iframe"),this.initializeElement();}else this.element=e,this.iframe=e;this.iframe.getAttribute("sandbox")||this.iframe.setAttribute("sandbox","allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts");let a=t.startRoute?new URL(t.startRoute,this.bundlerURL).toString():this.bundlerURL;(s=this.iframe.contentWindow)==null||s.location.replace(a),this.iframeProtocol=new m(this.iframe,this.bundlerURL),this.unsubscribeGlobalListener=this.iframeProtocol.globalListen(o=>{o.type!=="initialized"||!this.iframe.contentWindow||(this.iframeProtocol.register(),this.options.fileResolver&&(this.fileResolverProtocol=new g("fs",async i=>{if(i.method==="isFile")return this.options.fileResolver.isFile(i.params[0]);if(i.method==="readFile")return this.options.fileResolver.readFile(i.params[0]);throw new Error("Method not supported")},this.iframeProtocol)),this.updatePreview(this.sandboxInfo,!0));}),this.unsubscribeChannelListener=this.iframeProtocol.channelListen(o=>{switch(o.type){case"start":{this.errors=[];break}case"status":{this.status=o.status;break}case"action":{o.action==="show-error"&&(this.errors=[...this.errors,S(o)]);break}case"state":{this.bundlerState=o.state;break}}});}cleanup(){this.unsubscribeChannelListener(),this.unsubscribeGlobalListener(),this.iframeProtocol.cleanup();}updateOptions(e){L(this.options,e)||(this.options=e,this.updatePreview());}updatePreview(e=this.sandboxInfo,n){var i,c,l,u;this.sandboxInfo={...this.sandboxInfo,...e};let t=this.getFiles(),a=Object.keys(t).reduce((p,d)=>({...p,[d]:{code:t[d].code,path:d}}),{}),s=JSON.parse(b(this.sandboxInfo.dependencies,this.sandboxInfo.devDependencies,this.sandboxInfo.entry));try{s=JSON.parse(t["/package.json"].code);}catch(p){console.error("[sandpack-client]: could not parse package.json file: "+p.message);}let o=Object.keys(t).reduce((p,d)=>({...p,[d]:{content:t[d].code,path:d}}),{});this.dispatch({type:"compile",codesandbox:!0,version:3,isInitializationCompile:n,modules:a,reactDevTools:this.options.reactDevTools,externalResources:this.options.externalResources||[],hasFileResolver:Boolean(this.options.fileResolver),disableDependencyPreprocessing:this.sandboxInfo.disableDependencyPreprocessing,template:this.sandboxInfo.template||getTemplate(s,o),showOpenInCodeSandbox:(i=this.options.showOpenInCodeSandbox)!=null?i:!0,showErrorScreen:(c=this.options.showErrorScreen)!=null?c:!0,showLoadingScreen:(l=this.options.showLoadingScreen)!=null?l:!0,skipEval:this.options.skipEval||!1,clearConsoleDisabled:!this.options.clearConsoleOnFirstCompile,logLevel:(u=this.options.logLevel)!=null?u:h.Info});}dispatch(e){this.iframeProtocol.dispatch(e);}listen(e){return this.iframeProtocol.channelListen(e)}getCodeSandboxURL(){let e=this.getFiles(),n=Object.keys(e).reduce((t,a)=>({...t,[a.replace("/","")]:{content:e[a].code,isBinary:!1}}),{});return fetch("https://codesandbox.io/api/v1/sandboxes/define?json=1",{method:"POST",body:JSON.stringify({files:n}),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(t=>t.json()).then(t=>({sandboxId:t.sandbox_id,editorUrl:`https://codesandbox.io/s/${t.sandbox_id}`,embedUrl:`https://codesandbox.io/embed/${t.sandbox_id}`}))}getFiles(){let{sandboxInfo:e}=this;return e.files["/package.json"]===void 0?y(e.files,e.dependencies,e.devDependencies,e.entry):this.sandboxInfo.files}initializeElement(){if(this.iframe.style.border="0",this.iframe.style.width=this.options.width||"100%",this.iframe.style.height=this.options.height||"100%",this.iframe.style.overflow="hidden",!this.element.parentNode)throw new Error("[sandpack-client]: the given iframe does not have a parent.");this.element.parentNode.replaceChild(this.iframe,this.element);}};var h;(function(s){s[s.None=0]="None",s[s.Error=10]="Error",s[s.Warning=20]="Warning",s[s.Info=30]="Info",s[s.Debug=40]="Debug";})(h||(h={}));

export { R as SandpackClient, h as SandpackLogLevel, y as addPackageJSONIfNeeded, b as createPackageJSON, S as extractErrorDetails };
